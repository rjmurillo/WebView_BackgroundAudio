<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
<div id="status">Ready</div>
<script>
    // See https://mdn.github.io/webaudio-examples/decode-audio-data/

    // Create the AudioContext for the sound
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    // Create the buffer for the incoming sound
    let source = audioContext.createBufferSource();



    var updateStatus = function(status) {
            document.querySelector('#status').innerText = status;
        },
        jsonParse = function (args) {
        try {
            var o = JSON.parse(args);
            if (o && typeof o === "object") {
                return o;
            }
        } catch (e) { }

        return false;
    },
        raiseState = function(url, state) {
            const o = {
                url: url,
                state: state
            };
            console.log(o);
            updateStatus(state);
            window.external.notify(JSON.stringify(o));
        },
        loadSound = function(url) {
            console.log('Received URL', url);

            // Load the audio from a URI fetched with XHR
            let request = new XMLHttpRequest();
            // Use ASYNC
            request.open('GET', url, true);

            // AudioContext needs data in arraybuffer format
            request.responseType = 'arraybuffer';

            request.onload = function() {
                // Decode once the load is completed
                audioContext.decodeAudioData(
                    request.response,
                    (buffer) => {
                        source = audioContext.createBufferSource();
                        source.buffer = buffer;

                        // Connect the audio source to the context
                        source.connect(audioContext.destination);
                        source.start(0);

                        raiseState(url, 'playing');
                    },
                    e => {
                        console.error('Audio error', e);
                        raiseState(url, 'error');
                    });
            };

            raiseState(url, 'loading');

            // Initiate the XHR
            request.send();
        }, stopSound = function() {
            source.stop(0);
            raiseState(null, 'stopped');
        },
        // Main entry point for media playback UI
        mediaPlayback = function(args) {
            var obj = jsonParse(args);
            if (!obj) {
                console.error('Unknown args', args);
                raiseState(null, 'error');
            } else {
                if (obj.state === 'play') {
                    loadSound(obj.url);
                } else if (obj.state === 'stop') {
                    stopSound();
                }
            }
        };


</script>
</body>
</html>